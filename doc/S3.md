# S3 Storage Engine Configuration

pgmoneta supports Amazon Web Services (AWS) S3 and S3-compatible storage services as remote storage for backups.

## Amazon Web Services (AWS)

pgmoneta supports AWS S3 object storage service with path-style URLs.

```ini
storage_engine = s3

# Your access credentials
s3_access_key_id = <access_key_id>
s3_secret_access_key = <secret_access_key>

# Storage location
s3_bucket = <bucket_name>
s3_base_dir = <base_directory>

# AWS region (default: us-east-1)
s3_region = <region>

# Storage class for cost optimization (optional)
s3_storage_class = <storage_class>

# Custom port (default: 443 for TLS, 80 for non-TLS)
s3_port = <port>

# Enable or disable TLS for S3 (default: off, but enabled for port 443)
s3_use_tls = <on|off>
```

### Example

```ini
[pgmoneta]
storage_engine = s3
s3_access_key_id = <access_key_id>
s3_secret_access_key = <secret_access_key>
s3_bucket = <bucket_name>
s3_base_dir = <base_directory>
s3_region = <region>
s3_storage_class = <storage_class>
```

**Available AWS Storage Classes:**
- `STANDARD` - Default, frequent access
- `INTELLIGENT_TIERING` - Automatic cost optimization
- `STANDARD_IA` - Infrequent access
- `ONEZONE_IA` - Single AZ, infrequent access
- `GLACIER_INSTANT_RETRIEVAL` - Archive with instant retrieval
- `GLACIER_FLEXIBLE_RETRIEVAL` - Archive with flexible retrieval
- `GLACIER_DEEP_ARCHIVE` - Lowest cost archive
- `REDUCED_REDUNDANCY` - Legacy, not recommended

## S3-Compatible Storage (Garage)

pgmoneta supports self-hosted S3-compatible storage services like [Garage](https://garagehq.deuxfleurs.fr/) using path-style URLs.

```ini
storage_engine = s3

# Your access credentials
s3_access_key_id = <access_key_id>
s3_secret_access_key = <secret_access_key>

# Storage location
s3_bucket = <bucket_name>
s3_base_dir = <base_directory>

# Custom endpoint configuration
s3_endpoint = <endpoint_url>
s3_port = <port>
s3_region = <region>

# Enable or disable TLS for S3 (default: off, but enabled for port 443)
s3_use_tls = <on|off>
```

**Note:** When using `s3_endpoint`, the bucket name is included in the request path (path-style URLs). The `s3_storage_class` parameter is not supported with custom endpoints.

### Example

```ini
[pgmoneta]
storage_engine = s3
s3_access_key_id = <access_key_id>
s3_secret_access_key = <secret_access_key>
s3_bucket = <bucket_name>
s3_base_dir = <base_directory>
s3_endpoint = <endpoint_url>
s3_port = <port>
s3_region = <region>
```

### Tutorial: From Garage to `pgmoneta-cli s3 ls primary`

If you already have Garage downloaded and your S3 access key and secret key created, the flow is:

1. Start Garage so the S3 endpoint is reachable.
2. Configure pgmoneta to use your Garage endpoint.
3. Start pgmoneta.
4. Run `pgmoneta-cli s3 ls primary`.

Minimal configuration example:

```ini
[pgmoneta]
storage_engine = s3
s3_access_key_id = <garage_access_key_id>
s3_secret_access_key = <garage_secret_access_key>
s3_bucket = <garage_bucket_name>
s3_base_dir = pgmoneta
s3_endpoint = <garage_endpoint_host>
s3_port = <garage_endpoint_port>
s3_region = garage
s3_use_tls = off
```

Start pgmoneta:

```sh
pgmoneta -c pgmoneta.conf -u pgmoneta_users.conf
```

List remote objects:

```sh
pgmoneta-cli s3 ls primary
```

`pgmoneta-cli s3 ls` lists objects recursively under the configured server path and returns all objects in one result set.

## Per-Server Configuration

All S3 configuration settings can be specified within a server's configuration section. This allows you to use different S3 buckets, credentials, or even regions for different PostgreSQL servers.

When a server section has S3 settings, they override the global settings found in the `[pgmoneta]` section. If a server section does not specify a particular S3 setting, it will fall back to the value in the `[pgmoneta]` section.

If the `[pgmoneta]` section has no S3 configuration, then all required S3 settings must be specified in each server section that uses the S3 storage engine.

### Example with Per-Server Override

In this example, `server1` uses the global S3 bucket, but `server2` overrides it with its own bucket and credentials.

```ini
[pgmoneta]
host = localhost
unix_socket_dir = /tmp/
storage_engine = s3

# Global S3 configuration
s3_access_key_id = <global_access_key>
s3_secret_access_key = <global_secret_key>
s3_bucket = global-backup-bucket
s3_base_dir = pgmoneta
s3_region = us-east-1

[server1]
host = pg1.example.com
port = 5432
user = repl

# server1 uses the global S3 configuration.

[server2]
host = pg2.example.com
port = 5432
user = repl

# server2 overrides some S3 settings.
s3_access_key_id = <server2_access_key>
s3_secret_access_key = <server2_secret_key>
s3_bucket = server2-backup-bucket
```
